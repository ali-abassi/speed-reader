<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Speed Reader</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Newsreader:opsz,wght@6..72,300;6..72,400&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #0d0d0f 0%, #141419 100%);
      color: #e8e8ed;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px 24px;
      width: 100%;
    }

    header {
      text-align: center;
      padding: 0 0 16px;
    }

    h1 {
      font-size: 0.75rem;
      font-weight: 500;
      color: #f45866;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 12px;
    }

    .tagline {
      font-size: 1.1rem;
      font-weight: 300;
      color: #8a8a9e;
      max-width: 400px;
      margin: 0 auto;
      line-height: 1.5;
    }

    .tagline strong {
      color: #e8e8ed;
    }

    .reader-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      padding: 50px 20px;
      position: relative;
      background: rgba(255,255,255,0.01);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.04);
      transition: all 0.3s ease;
    }

    .reader-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #3a3a4a;
      font-size: 0.9rem;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .reader-hint.hidden {
      opacity: 0;
    }

    .reader-hint .hint-icon {
      font-size: 2rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .word-display {
      font-size: 4.5rem;
      font-weight: 300;
      min-height: 100px;
      position: relative;
      width: 100%;
      font-family: 'Newsreader', Georgia, serif;
      letter-spacing: -0.02em;
    }

    .word-inner {
      position: absolute;
      white-space: nowrap;
      display: inline-block;
    }

    .word-display .before {
      color: rgba(255,255,255,0.9);
    }

    .word-display .orp {
      color: #f45866;
    }

    .word-display .after {
      color: rgba(255,255,255,0.5);
    }

    .focus-line {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 160px;
      pointer-events: none;
    }

    .focus-line::before,
    .focus-line::after {
      content: '';
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 25px;
      background: rgba(255,255,255,0.4);
    }

    .focus-line::before {
      top: 0;
    }

    .focus-line::after {
      bottom: 0;
    }

    .wpm-display {
      position: absolute;
      bottom: 24px;
      right: 28px;
      font-size: 0.8rem;
      font-weight: 400;
      color: #5a5a6e;
      font-variant-numeric: tabular-nums;
    }

    .wpm-display span {
      color: #8a8a9e;
    }

    .progress-bar {
      width: 100%;
      height: 2px;
      background: rgba(255,255,255,0.06);
      margin-top: 32px;
      border-radius: 1px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #f45866, #ff7b87);
      width: 0%;
      transition: width 0.15s ease-out;
    }

    .controls {
      padding: 20px 0 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .control-row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      color: #b8b8c8;
      padding: 12px 28px;
      font-size: 0.85rem;
      font-weight: 400;
      cursor: pointer;
      border-radius: 100px;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    button:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.12);
      color: #fff;
    }

    button:active {
      transform: scale(0.97);
    }

    button.primary {
      background: #f45866;
      border-color: transparent;
      color: #fff;
      font-weight: 500;
      padding: 14px 36px;
    }

    button.primary:hover {
      background: #ff6b78;
      box-shadow: 0 4px 24px rgba(244,88,102,0.3);
    }

    .secondary-controls {
      margin-top: 8px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.04);
    }

    .secondary-controls button,
    .secondary-controls .btn-link {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      color: #8a8a9e;
      padding: 10px 18px;
      font-size: 0.8rem;
    }

    .secondary-controls button:hover,
    .secondary-controls .btn-link:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.1);
      color: #b8b8c8;
    }

    .btn-link {
      display: inline-block;
      text-decoration: none;
      font-family: inherit;
      cursor: pointer;
      border-radius: 100px;
      transition: all 0.2s ease;
    }

    #exportBtn.recording {
      background: rgba(244,67,54,0.2);
      border-color: rgba(244,67,54,0.4);
      color: #f44336;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .export-canvas {
      position: fixed;
      top: -9999px;
      left: -9999px;
    }

    .speed-control {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .speed-control label {
      color: #5a5a6e;
      font-size: 0.8rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .speed-control input[type="range"] {
      width: 180px;
      height: 4px;
      -webkit-appearance: none;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      outline: none;
    }

    .speed-control input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #f45866;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(244,88,102,0.4);
    }

    .speed-value {
      color: #f45866;
      font-weight: 500;
      font-size: 0.9rem;
      min-width: 70px;
      font-variant-numeric: tabular-nums;
    }

    .text-input-area {
      padding: 12px 0 0;
    }

    .textarea-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .textarea-label {
      font-size: 0.8rem;
      font-weight: 500;
      color: #5a5a6e;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .textarea-actions {
      display: flex;
      gap: 8px;
    }

    .textarea-actions button {
      padding: 6px 14px;
      font-size: 0.75rem;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.06);
      color: #a8a8b8;
      padding: 16px;
      font-size: 0.9rem;
      font-family: inherit;
      border-radius: 12px;
      resize: vertical;
      line-height: 1.5;
    }

    textarea:focus {
      outline: none;
      border-color: rgba(244,88,102,0.4);
      background: rgba(255,255,255,0.03);
    }

    textarea::placeholder {
      color: #4a4a5a;
    }

    .stats {
      display: flex;
      gap: 20px;
      justify-content: center;
      padding: 10px 0;
      color: #5a5a6e;
      font-size: 0.75rem;
    }

    .stat {
      font-variant-numeric: tabular-nums;
    }

    .stat span {
      color: #8a8a9e;
    }

    .mode-toggle {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    .mode-toggle button {
      padding: 8px 16px;
      font-size: 0.75rem;
    }

    .mode-toggle button.active {
      background: rgba(244,88,102,0.15);
      border-color: rgba(244,88,102,0.3);
      color: #f45866;
    }

    /* Info sections */
    .info-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
    }

    .info-card {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 24px;
    }

    .info-card h3 {
      font-size: 0.7rem;
      font-weight: 500;
      color: #f45866;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 12px;
    }

    .info-card p {
      font-size: 0.85rem;
      color: #8a8a9e;
      line-height: 1.7;
    }

    .info-card ul {
      list-style: none;
      font-size: 0.85rem;
      color: #8a8a9e;
    }

    .info-card li {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }

    .info-card li:last-child {
      border-bottom: none;
    }

    .info-card .key {
      color: #5a5a6e;
      font-family: 'SF Mono', monospace;
      font-size: 0.75rem;
      background: rgba(255,255,255,0.05);
      padding: 2px 8px;
      border-radius: 4px;
      min-width: 70px;
      text-align: center;
    }

    .research-link {
      color: #f45866;
      text-decoration: none;
    }

    .research-link:hover {
      text-decoration: underline;
    }

    /* Theater mode */
    .theater-mode {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 1000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .theater-mode.active {
      display: flex;
    }

    .theater-mode .reader-area {
      width: 100%;
      max-width: none;
      height: 100%;
      min-height: auto;
      border: none;
      border-radius: 0;
      background: transparent;
    }

    .theater-mode .word-display {
      font-size: 8rem;
    }

    .theater-mode .focus-line {
      height: 200px;
    }

    .theater-mode .focus-line::before,
    .theater-mode .focus-line::after {
      height: 30px;
    }

    .theater-mode .wpm-display {
      font-size: 1rem;
      bottom: 40px;
      right: 50px;
    }

    .theater-mode .progress-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      margin: 0;
      height: 4px;
      border-radius: 0;
    }

    .theater-exit {
      position: absolute;
      top: 30px;
      right: 30px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: #888;
      padding: 12px 20px;
      font-size: 0.85rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .theater-exit:hover {
      background: rgba(255,255,255,0.15);
      color: #fff;
    }

    .theater-controls {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .theater-mode:hover .theater-controls {
      opacity: 1;
    }

    .theater-controls button {
      background: rgba(255,255,255,0.1);
      border: none;
      padding: 12px 24px;
    }

    .theater-hint {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      color: #444;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .theater-mode:hover .theater-hint {
      opacity: 1;
    }

    /* Test Section with Portraits */
    .test-section {
      margin-top: 24px;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(244,88,102,0.08) 0%, rgba(255,123,135,0.04) 100%);
      border: 1px solid rgba(244,88,102,0.15);
      border-radius: 16px;
      text-align: center;
    }

    .test-section-header {
      margin-bottom: 16px;
    }

    .test-section-title {
      font-size: 1.2rem;
      font-weight: 400;
      color: #e8e8ed;
      margin-bottom: 4px;
    }

    .test-section-subtitle {
      font-size: 0.8rem;
      color: #8a8a9e;
    }

    /* Famous Readers Lineup */
    .famous-lineup {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 6px;
      margin: 16px 0;
      padding: 0 8px;
    }

    .famous-person {
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 0.85;
      transition: all 0.2s;
    }

    .famous-person:hover {
      opacity: 1;
      transform: translateY(-2px);
    }

    .famous-person img {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      object-position: top;
      border: 2px solid rgba(255,255,255,0.15);
      background: #fff;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      transition: all 0.2s;
    }

    .famous-person:hover img {
      border-color: rgba(244,88,102,0.5);
      box-shadow: 0 6px 20px rgba(244,88,102,0.25);
    }

    .famous-person .name {
      font-size: 0.6rem;
      color: #6a6a7e;
      margin-top: 6px;
      white-space: nowrap;
    }

    .famous-person .wpm {
      font-size: 0.55rem;
      color: #4a4a5a;
    }

    .famous-divider {
      color: #3a3a4a;
      font-size: 1rem;
      margin: 0 2px 24px;
    }

    .you-marker {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 4px;
    }

    .you-marker .you-circle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px dashed rgba(244,88,102,0.5);
      background: rgba(244,88,102,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .you-marker .name {
      font-size: 0.65rem;
      color: #f45866;
      margin-top: 6px;
      font-weight: 500;
    }

    .you-marker .wpm {
      font-size: 0.55rem;
      color: #a85860;
    }

    .test-cta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 28px;
      background: #f45866;
      color: #fff;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 100px;
      transition: all 0.2s;
      margin-top: 4px;
    }

    .test-cta:hover {
      background: #ff6b78;
      box-shadow: 0 6px 24px rgba(244,88,102,0.4);
      transform: translateY(-2px);
    }

    .test-cta svg {
      width: 18px;
      height: 18px;
    }

    @media (max-width: 700px) {
      .info-grid {
        grid-template-columns: 1fr;
      }

      .word-display {
        font-size: 2.8rem;
      }

      .theater-mode .word-display {
        font-size: 4rem;
      }

      .speed-control input[type="range"] {
        width: 120px;
      }

      .container {
        padding: 24px 16px;
      }

      .famous-lineup {
        gap: 4px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .famous-person img,
      .you-marker .you-circle {
        width: 40px;
        height: 40px;
      }

      .famous-person .name,
      .you-marker .name {
        font-size: 0.5rem;
      }

      .famous-person .wpm,
      .you-marker .wpm {
        font-size: 0.45rem;
      }

      .famous-divider {
        font-size: 0.9rem;
        margin: 0 2px 24px;
      }

      .test-section {
        padding: 24px 16px;
      }

      .test-section-title {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Speed Reader</h1>
      <p class="tagline">Read faster by focusing on one word at a time. Paste your text below and hit <strong>Play</strong>.</p>
    </header>

    <div class="reader-area" id="readerArea">
      <div class="reader-hint" id="readerHint">
        <div class="hint-icon">&#9660;</div>
        <div>Paste text below, then press Play</div>
      </div>
      <div class="focus-line"></div>
      <div class="word-display" id="wordDisplay">
        <div class="word-inner" id="wordInner">
          <span class="before"></span><span class="orp"></span><span class="after"></span>
        </div>
      </div>
      <div class="wpm-display"><span id="currentWpm">300</span> wpm</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div class="controls">
      <div class="control-row main-controls">
        <button id="playBtn" class="primary">Play</button>
        <button id="resetBtn">Reset</button>
        <div class="speed-control">
          <input type="range" id="wpmSlider" min="100" max="1200" value="300" step="50">
          <span class="speed-value" id="wpmValue">300 wpm</span>
        </div>
      </div>

      <div class="control-row mode-toggle">
        <button id="modeFixed" class="active">Fixed</button>
        <button id="modeRamp">Ramp Up</button>
      </div>

      <div class="stats">
        <span class="stat">Words: <span id="wordCount">0</span></span>
        <span class="stat">Progress: <span id="wordProgress">0/0</span></span>
        <span class="stat">Time: <span id="timeEstimate">0:00</span></span>
      </div>

      <div class="control-row secondary-controls">
        <button id="theaterBtn">Focus Mode</button>
        <button id="exportBtn">Export as Video</button>
        <a href="test.html" class="btn-link">Test Your Reading Speed</a>
      </div>
    </div>

    <div class="text-input-area">
      <div class="textarea-header">
        <span class="textarea-label">Your Text</span>
        <div class="textarea-actions">
          <button id="pasteBtn">Paste</button>
          <button id="clearBtn">Clear</button>
        </div>
      </div>
      <textarea id="textInput" placeholder="Paste any text here - articles, books, emails..."></textarea>
    </div>

    <div class="info-section">
      <div class="info-grid">
        <div class="info-card">
          <h3>How to Use</h3>
          <ul>
            <li><span class="key">Space</span> Play / Pause</li>
            <li><span class="key">Arrow Keys</span> Adjust speed</li>
            <li><span class="key">R</span> Reset to beginning</li>
            <li><span class="key">F</span> Toggle full screen</li>
            <li><span class="key">Esc</span> Exit full screen</li>
          </ul>
        </div>
        <div class="info-card">
          <h3>The Science</h3>
          <p>
            This uses <strong>RSVP</strong> (Rapid Serial Visual Presentation) with the <strong>Optimal Viewing Position</strong> highlighted in red. Research by <a href="https://www.researchgate.net/publication/16964612" class="research-link" target="_blank">O'Regan et al. (1984)</a> found we fixate slightly left of center when reading - about 25-30% into each word. The red letter marks this spot so your eye stays fixed while words flow past.
          </p>
        </div>
      </div>
    </div>

    <!-- Test Section with Famous Readers -->
    <div class="test-section">
      <div class="test-section-header">
        <h2 class="test-section-title">How Fast Can You Read?</h2>
        <p class="test-section-subtitle">Find your speed and see where you rank among famous readers</p>
      </div>

      <div class="famous-lineup">
        <div class="famous-person">
          <img src="images/tom-cruise.jpg" alt="Tom Cruise">
          <span class="name">Tom Cruise</span>
          <span class="wpm">180 WPM</span>
        </div>

        <span class="famous-divider">&lt;</span>

        <div class="famous-person">
          <img src="images/steph-curry.jpg" alt="Steph Curry">
          <span class="name">Steph Curry</span>
          <span class="wpm">350 WPM</span>
        </div>

        <span class="famous-divider">&lt;</span>

        <div class="you-marker">
          <div class="you-circle">?</div>
          <span class="name">YOU</span>
          <span class="wpm">??? WPM</span>
        </div>

        <span class="famous-divider">&lt;</span>

        <div class="famous-person">
          <img src="images/donald-trump.jpg" alt="Donald Trump">
          <span class="name">Trump</span>
          <span class="wpm">400 WPM</span>
        </div>

        <span class="famous-divider">&lt;</span>

        <div class="famous-person">
          <img src="images/mark-zuckerberg.jpg" alt="Mark Zuckerberg">
          <span class="name">Zuckerberg</span>
          <span class="wpm">450 WPM</span>
        </div>

        <span class="famous-divider">&lt;</span>

        <div class="famous-person">
          <img src="images/elon-musk.jpg" alt="Elon Musk">
          <span class="name">Elon Musk</span>
          <span class="wpm">500 WPM</span>
        </div>

        <span class="famous-divider">&lt;</span>

        <div class="famous-person">
          <img src="images/bill-gates.jpg" alt="Bill Gates">
          <span class="name">Bill Gates</span>
          <span class="wpm">750 WPM</span>
        </div>
      </div>

      <a href="test.html" class="test-cta">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
        </svg>
        Take the Test
      </a>
    </div>
  </div>

  <!-- Export Canvas (hidden) - 16:9 landscape -->
  <canvas id="exportCanvas" class="export-canvas" width="1920" height="1080"></canvas>

  <!-- Theater Mode -->
  <div class="theater-mode" id="theaterMode">
    <button class="theater-exit" id="theaterExit">Exit (Esc)</button>
    <div class="reader-area">
      <div class="focus-line"></div>
      <div class="word-display" id="theaterWordDisplay">
        <div class="word-inner" id="theaterWordInner">
          <span class="before"></span><span class="orp"></span><span class="after"></span>
        </div>
      </div>
      <div class="wpm-display"><span id="theaterWpm">300</span> wpm</div>
      <div class="progress-bar">
        <div class="progress-fill" id="theaterProgress"></div>
      </div>
    </div>
    <div class="theater-hint">Space to play/pause &bull; Arrow keys for speed &bull; Esc to exit</div>
    <div class="theater-controls">
      <button id="theaterPlayBtn">Play</button>
      <button id="theaterPauseBtn">Pause</button>
      <button id="theaterResetBtn">Reset</button>
    </div>
  </div>

  <script type="module">
    import { Muxer, ArrayBufferTarget } from 'https://cdn.jsdelivr.net/npm/mp4-muxer@5.1.3/build/mp4-muxer.mjs';

    const wordDisplay = document.getElementById('wordDisplay');
    const wordInner = document.getElementById('wordInner');
    const readerHint = document.getElementById('readerHint');
    const playBtn = document.getElementById('playBtn');
    const resetBtn = document.getElementById('resetBtn');
    const wpmSlider = document.getElementById('wpmSlider');
    const wpmValue = document.getElementById('wpmValue');
    const currentWpm = document.getElementById('currentWpm');
    const textInput = document.getElementById('textInput');
    const progressFill = document.getElementById('progressFill');
    const wordCount = document.getElementById('wordCount');
    const wordProgress = document.getElementById('wordProgress');
    const timeEstimate = document.getElementById('timeEstimate');
    const modeFixed = document.getElementById('modeFixed');
    const modeRamp = document.getElementById('modeRamp');
    const pasteBtn = document.getElementById('pasteBtn');
    const clearBtn = document.getElementById('clearBtn');

    // Theater mode elements
    const theaterMode = document.getElementById('theaterMode');
    const theaterBtn = document.getElementById('theaterBtn');
    const theaterExit = document.getElementById('theaterExit');
    const theaterWordDisplay = document.getElementById('theaterWordDisplay');
    const theaterWordInner = document.getElementById('theaterWordInner');
    const theaterWpm = document.getElementById('theaterWpm');
    const theaterProgress = document.getElementById('theaterProgress');
    const theaterPlayBtn = document.getElementById('theaterPlayBtn');
    const theaterPauseBtn = document.getElementById('theaterPauseBtn');
    const theaterResetBtn = document.getElementById('theaterResetBtn');

    let words = [];
    let currentIndex = 0;
    let isPlaying = false;
    let timeoutId = null;
    let wpm = 300;
    let rampMode = false;
    let isTheaterMode = false;
    const RAMP_START = 300;
    const RAMP_END = 900;

    // Calculate ORP position (about 25-30% into the word)
    function getOrpIndex(word) {
      if (word.length <= 1) return 0;
      if (word.length <= 3) return 1;
      return Math.floor(word.length * 0.28);
    }

    function displayWord(word, targetInner, targetDisplay) {
      const inner = targetInner || wordInner;
      const display = targetDisplay || wordDisplay;

      if (!word) {
        inner.innerHTML = '<span class="before"></span><span class="orp"></span><span class="after"></span>';
        inner.style.left = '50%';
        inner.style.transform = 'translateX(-50%) translateY(-50%)';
        inner.style.top = '50%';
        return;
      }

      const orpIndex = getOrpIndex(word);
      const before = word.slice(0, orpIndex);
      const orp = word[orpIndex];
      const after = word.slice(orpIndex + 1);

      inner.innerHTML = `<span class="before">${before}</span><span class="orp">${orp}</span><span class="after">${after}</span>`;

      const orpEl = inner.querySelector('.orp');
      const containerWidth = display.offsetWidth;
      const containerCenter = containerWidth / 2;

      const orpRect = orpEl.getBoundingClientRect();
      const innerRect = inner.getBoundingClientRect();
      const orpCenterInWord = (orpRect.left - innerRect.left) + (orpRect.width / 2);

      const leftOffset = containerCenter - orpCenterInWord;
      inner.style.left = leftOffset + 'px';
      inner.style.transform = 'translateY(-50%)';
      inner.style.top = '50%';
    }

    function updateAllDisplays(word) {
      displayWord(word, wordInner, wordDisplay);
      if (isTheaterMode) {
        displayWord(word, theaterWordInner, theaterWordDisplay);
      }
    }

    function parseText() {
      const text = textInput.value.trim();
      words = text.split(/\s+/).filter(w => w.length > 0);
      wordCount.textContent = words.length;
      updateProgress();
      // Hide hint when there's text
      if (words.length > 0) {
        readerHint.classList.add('hidden');
      } else {
        readerHint.classList.remove('hidden');
      }
    }

    function updateProgress() {
      const progress = words.length > 0 ? (currentIndex / words.length) * 100 : 0;
      progressFill.style.width = progress + '%';
      theaterProgress.style.width = progress + '%';
      wordProgress.textContent = `${currentIndex}/${words.length}`;

      const remainingWords = words.length - currentIndex;
      const currentWpmVal = rampMode ? getCurrentRampWpm() : wpm;
      const minutes = remainingWords / currentWpmVal;
      const mins = Math.floor(minutes);
      const secs = Math.floor((minutes - mins) * 60);
      timeEstimate.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function getCurrentRampWpm() {
      if (!rampMode || words.length === 0) return wpm;
      const progress = currentIndex / words.length;
      return Math.round(RAMP_START + (RAMP_END - RAMP_START) * progress);
    }

    function updateWpmDisplay() {
      const displayWpm = rampMode ? getCurrentRampWpm() : wpm;
      currentWpm.textContent = displayWpm;
      theaterWpm.textContent = displayWpm;
    }

    function getDelay() {
      const currentWpmVal = rampMode ? getCurrentRampWpm() : wpm;
      return 60000 / currentWpmVal;
    }

    function showNextWord() {
      if (currentIndex >= words.length) {
        stop();
        updateAllDisplays('Done!');
        return;
      }

      updateAllDisplays(words[currentIndex]);
      currentIndex++;
      updateProgress();
      updateWpmDisplay();

      if (isPlaying) {
        timeoutId = setTimeout(showNextWord, getDelay());
      }
    }

    function play() {
      if (words.length === 0) {
        parseText();
      }
      if (words.length === 0) return;

      isPlaying = true;
      playBtn.textContent = 'Playing...';
      theaterPlayBtn.textContent = 'Playing...';
      showNextWord();
    }

    function pause() {
      isPlaying = false;
      playBtn.textContent = 'Play';
      theaterPlayBtn.textContent = 'Play';
      if (timeoutId) {
        clearTimeout(timeoutId);
        timeoutId = null;
      }
    }

    function stop() {
      pause();
      playBtn.textContent = 'Play';
      theaterPlayBtn.textContent = 'Play';
    }

    function reset() {
      stop();
      currentIndex = 0;
      parseText();
      updateAllDisplays('');
      updateWpmDisplay();
    }

    // Theater mode
    function enterTheater() {
      isTheaterMode = true;
      theaterMode.classList.add('active');
      document.body.style.overflow = 'hidden';
      // Sync the display
      if (currentIndex > 0 && currentIndex <= words.length) {
        displayWord(words[currentIndex - 1], theaterWordInner, theaterWordDisplay);
      }
      updateWpmDisplay();
      updateProgress();
    }

    function exitTheater() {
      isTheaterMode = false;
      theaterMode.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Event listeners
    playBtn.addEventListener('click', () => isPlaying ? pause() : play());
    resetBtn.addEventListener('click', reset);
    theaterPlayBtn.addEventListener('click', () => isPlaying ? pause() : play());
    theaterPauseBtn.addEventListener('click', pause);
    theaterResetBtn.addEventListener('click', reset);

    theaterBtn.addEventListener('click', enterTheater);
    theaterExit.addEventListener('click', exitTheater);

    wpmSlider.addEventListener('input', (e) => {
      wpm = parseInt(e.target.value);
      wpmValue.textContent = wpm + ' wpm';
      updateWpmDisplay();
      updateProgress();
    });

    textInput.addEventListener('input', reset);

    // Paste and clear buttons
    pasteBtn.addEventListener('click', async () => {
      try {
        const text = await navigator.clipboard.readText();
        textInput.value = text;
        reset();
      } catch (err) {
        textInput.focus();
        document.execCommand('paste');
      }
    });

    clearBtn.addEventListener('click', () => {
      textInput.value = '';
      reset();
    });

    modeFixed.addEventListener('click', () => {
      rampMode = false;
      modeFixed.classList.add('active');
      modeRamp.classList.remove('active');
      wpmSlider.disabled = false;
      updateWpmDisplay();
      updateProgress();
    });

    modeRamp.addEventListener('click', () => {
      rampMode = true;
      modeRamp.classList.add('active');
      modeFixed.classList.remove('active');
      wpmSlider.disabled = true;
      updateWpmDisplay();
      updateProgress();
    });

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
      if (e.target === textInput) return;

      if (e.code === 'Space') {
        e.preventDefault();
        if (isPlaying) pause();
        else play();
      } else if (e.code === 'ArrowUp' || e.code === 'ArrowRight') {
        e.preventDefault();
        if (!rampMode) {
          wpm = Math.min(1200, wpm + 50);
          wpmSlider.value = wpm;
          wpmValue.textContent = wpm + ' wpm';
          updateWpmDisplay();
        }
      } else if (e.code === 'ArrowDown' || e.code === 'ArrowLeft') {
        e.preventDefault();
        if (!rampMode) {
          wpm = Math.max(100, wpm - 50);
          wpmSlider.value = wpm;
          wpmValue.textContent = wpm + ' wpm';
          updateWpmDisplay();
        }
      } else if (e.code === 'KeyR') {
        e.preventDefault();
        reset();
      } else if (e.code === 'KeyF') {
        e.preventDefault();
        if (isTheaterMode) exitTheater();
        else enterTheater();
      } else if (e.code === 'Escape') {
        if (isTheaterMode) exitTheater();
      }
    });

    // Video Export
    const exportBtn = document.getElementById('exportBtn');
    const exportCanvas = document.getElementById('exportCanvas');
    const ctx = exportCanvas.getContext('2d');
    let isExporting = false;

    function getExportOrpIndex(word) {
      if (word.length <= 1) return 0;
      if (word.length <= 3) return 1;
      return Math.floor(word.length * 0.28);
    }

    function drawWordToCanvas(word, currentWpmVal) {
      // Canvas is 1920x1080 (16:9 landscape)
      const W = 1920;
      const H = 1080;

      // Dark background
      ctx.fillStyle = '#000000';
      ctx.fillRect(0, 0, W, H);

      if (!word) return;

      const orpIndex = getExportOrpIndex(word);
      const before = word.slice(0, orpIndex);
      const orp = word[orpIndex] || '';
      const after = word.slice(orpIndex + 1);

      // Set font - large text
      ctx.font = '240px Newsreader, Georgia, serif';
      ctx.textBaseline = 'middle';

      // Measure parts
      const beforeWidth = ctx.measureText(before).width;
      const orpWidth = ctx.measureText(orp).width;

      // Center ORP letter
      const centerX = W / 2;
      const centerY = H / 2 - 40; // Shift up slightly to make room for WPM below
      const startX = centerX - beforeWidth - (orpWidth / 2);

      // Draw horizontal lines across full width (above and below word area)
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.lineWidth = 1;
      // Top line
      ctx.beginPath();
      ctx.moveTo(0, centerY - 160);
      ctx.lineTo(W, centerY - 160);
      ctx.stroke();
      // Bottom line
      ctx.beginPath();
      ctx.moveTo(0, centerY + 160);
      ctx.lineTo(W, centerY + 160);
      ctx.stroke();

      // Draw short vertical alignment marks at center
      ctx.strokeStyle = 'rgba(255,255,255,0.3)';
      ctx.beginPath();
      ctx.moveTo(centerX, centerY - 160);
      ctx.lineTo(centerX, centerY - 120);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(centerX, centerY + 120);
      ctx.lineTo(centerX, centerY + 160);
      ctx.stroke();

      // Draw before (white)
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      ctx.fillText(before, startX, centerY);

      // Draw ORP (red)
      ctx.fillStyle = '#f45866';
      ctx.fillText(orp, startX + beforeWidth, centerY);

      // Draw after (faded)
      ctx.fillStyle = 'rgba(255,255,255,0.5)';
      ctx.fillText(after, startX + beforeWidth + orpWidth, centerY);

      // Draw WPM centered below the word
      ctx.font = '42px Inter, sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.5)';
      ctx.textAlign = 'center';
      ctx.fillText(currentWpmVal + ' wpm', centerX, centerY + 200);
      ctx.textAlign = 'left';
    }

    async function exportVideo() {
      if (words.length === 0) {
        parseText();
      }
      if (words.length === 0) {
        alert('Please enter some text first');
        return;
      }

      // Check WebCodecs support
      if (typeof VideoEncoder === 'undefined') {
        alert('Your browser does not support video encoding. Please use Chrome or Edge.');
        return;
      }

      // Calculate estimated duration
      const exportRampMode = rampMode;
      const exportWpm = wpm;
      const totalWords = words.length;
      let estSeconds;
      if (exportRampMode) {
        estSeconds = (totalWords / 600) * 60;
      } else {
        estSeconds = (totalWords / exportWpm) * 60;
      }

      // Warn if video is longer than 2 minutes
      if (estSeconds > 120) {
        const mins = Math.floor(estSeconds / 60);
        const secs = Math.round(estSeconds % 60);
        const proceed = confirm(
          `Video will be ~${mins}:${secs.toString().padStart(2, '0')} long.\n\n` +
          `Consider using fewer words or faster speed for shorter videos.\n\nExport anyway?`
        );
        if (!proceed) return;
      }

      isExporting = true;
      exportBtn.classList.add('recording');
      exportBtn.textContent = 'Encoding...';

      const W = 1920;
      const H = 1080;
      const fps = 30;

      try {
        // Setup mp4-muxer
        const muxer = new Muxer({
          target: new ArrayBufferTarget(),
          video: {
            codec: 'avc',
            width: W,
            height: H,
          },
          fastStart: 'in-memory',
        });

        // Setup VideoEncoder
        const encoder = new VideoEncoder({
          output: (chunk, meta) => muxer.addVideoChunk(chunk, meta),
          error: (e) => console.error('Encoder error:', e),
        });

        encoder.configure({
          codec: 'avc1.640028',
          width: W,
          height: H,
          bitrate: 8_000_000,
          framerate: fps,
        });

        let frameIndex = 0;
        let timestamp = 0;

        // Encode each word
        for (let i = 0; i < totalWords; i++) {
          if (!isExporting) break;

          let currentWpmVal;
          if (exportRampMode) {
            const progress = i / totalWords;
            currentWpmVal = Math.round(RAMP_START + (RAMP_END - RAMP_START) * progress);
          } else {
            currentWpmVal = exportWpm;
          }

          drawWordToCanvas(words[i], currentWpmVal);

          // Calculate how many frames for this word
          const wordDurationMs = 60000 / currentWpmVal;
          const numFrames = Math.max(1, Math.round((wordDurationMs / 1000) * fps));

          for (let f = 0; f < numFrames; f++) {
            const frame = new VideoFrame(exportCanvas, {
              timestamp: timestamp,
              duration: 1_000_000 / fps,
            });
            encoder.encode(frame, { keyFrame: frameIndex % 30 === 0 });
            frame.close();
            timestamp += 1_000_000 / fps;
            frameIndex++;
          }

          // Update progress
          const pct = Math.round(((i + 1) / totalWords) * 100);
          exportBtn.textContent = `Encoding ${pct}%`;

          // Yield to UI
          if (i % 10 === 0) await new Promise(r => setTimeout(r, 0));
        }

        // Final "Done!" frame for 1 second
        drawWordToCanvas('Done!', exportRampMode ? RAMP_END : exportWpm);
        for (let f = 0; f < fps; f++) {
          const frame = new VideoFrame(exportCanvas, {
            timestamp: timestamp,
            duration: 1_000_000 / fps,
          });
          encoder.encode(frame, { keyFrame: false });
          frame.close();
          timestamp += 1_000_000 / fps;
        }

        // Finalize
        await encoder.flush();
        muxer.finalize();

        const { buffer } = muxer.target;
        const blob = new Blob([buffer], { type: 'video/mp4' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'speed-reader.mp4';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('Export failed:', err);
        alert('Video export failed: ' + err.message);
      }

      isExporting = false;
      exportBtn.classList.remove('recording');
      exportBtn.textContent = 'Export as Video';
    }

    exportBtn.addEventListener('click', () => {
      if (isExporting) {
        isExporting = false;
      } else {
        exportVideo();
      }
    });

    // Initialize
    parseText();
    updateWpmDisplay();
  </script>
</body>
</html>
